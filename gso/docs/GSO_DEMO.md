# On the Fly Note-Taking: Google SecOps Demo - Log Ingestion, Threat detection, Incident Response, and Investigation

This file documents the process I followed on the fly; i.e., at the same time of writing this file, to set up a demonstration of Google Security Operations to ingest events, detect and incident, respond to an incident, and investigate the incident.

1. **Log Ingestion**: Is the process of setting up the telemetry pipeline that is received by the security solution, in this case GSO. The ingestion phase will cover the deployment of a log ingestion pipeline and the deliberated generation of suspicious and malicious events.

2. **Threat Detection**: The process of generating alerts in the security solution. For Google SecOps, this corresponds to enabling Mandiant curated detection, developing custom detection rules.

3. **Incident Response**: The process of inspecting the alerts generated by the security solution, assign responsibles, and perform triaging operations. If applicable, leverage SOAR workflows to automate actions.

4. **Investigation**: The process of analyzing the data and information from the incident. Afterwards, forensic operations can be pursued in the affected hosts to determine the root causes of the incident.

Moreover, there are other features of Google SecOps that we will cover, like the Looker Dashboards, useful for analytics in every phase of security operations. Other advanced features like Google Threat Intelligence and Google SecOps SOAR connectors (alerts) are out-of-scope of this demo.

## Environment Prerequisites

For this demo I will be using Proxmox VE 8.3.3 to run some virtual machines:

- Windows Server 2019 (Domain Controller, DC)
- Windows 10 Pro (Workstation, WS)
- Windows 10 Pro (Windows Event Collector, WEC)
- Optionally, an OPNSense Firewall (Gateway, GW)

Additionally, you can create another VM for Kali Linux or just use your host/physical computer for that matter.

There is no reason to use Proxmox VE (VirualBox or VMWare would also do the trick) or to virtualize the environment, as long as you have the equipment though.

Most of the setup for this environment was taken from The Cyber Mentor's YouTube video [Hacking Active Directory for Beginners](https://www.youtube.com/watch?v=VXxH4n684HE&t=1304s&ab_channel=TheCyberMentor)
, with a few additions. You can follow along that video while considering the extra configuration steps listed in this file.

![Topology](/media/gso_demo_topology.jpg)

### Proxmox Configuration

Configure [NTP servers](https://developers.google.com/time/guides#linux) in Proxmox host to ensure that the virtual machines have a proper time when initialized.

Create the virtual machines with [Windows Server 2019](https://pve.proxmox.com/wiki/Windows_2019_guest_best_practices) and two with [Windows 10](https://pve.proxmox.com/wiki/Windows_10_guest_best_practices). Finally, create a last VM for the [OPNSense Firewall](https://www.zenarmor.com/docs/network-security-tutorials/opnsense-installation).

![Pene](/media/gso_demo_ntpconfig.png)

### OPNSense Firewall

Deploy the firewall as the gateway between your physical network and your virtual network. No special configuration is implemented here.

### Windows Server 2019 - Domain Controller

#### Essential settings

1. **Change the computer hostname**. For Example: `DC01` or `LAB-DC`.
2. **Configure static IPv4 addressing**. 
    - If you decided to include the OPNsense Firewall as separator between the physical network and the virtual environment, use the internal network address. For example, I used the network `172.16.0.0/24` and I assigned the IP address `172.16.0.100` to my DC.
    - If you didn't add the OPNsense Firewall, still assign a static free address from your local network.
3. **Configure the timezone**.
4. **Run Windows Update**.
5. Make sure you **enable Windows Remote Desktop**.
    - In my lab, one of my WS will have two NICs, one facing the physical network and another facing to the virtual network. This is to avoid having to set up port forwarding or VPNs.
    - Having a direct connection to that WS, and it having access to the virtual network, I can use Windows RDP to access any computer in the laboratory.

Once you have your DC with the most essential configurations ready, move to *AD Users and Computers* to create some user accounts and give your environment a little bit more of context and live.

#### Create users

1. **Create a normal user account** with a weak password (E.g. 'Password1').
2. **Create an administrator user account** with a barely secure password by right-clicking the Administrator user and selecting the *copy* option (E.g. 'P4ssw0rd.').
3. **Create a service account** (E.g. 'SQL Service') with a somewhat secure password that is  included in the user's description in plaintext (E.g. 'MyS3cur3P4ssw0rd!').

#### Create a network share

Create a basic network share. Go to *File and Storage Services > Shares* and create a new *Quick SMB Share*. Name the share as you which; you can leave all settings in their default values. As an example, I created the network share `C:\Shares\Developers`.

If you cannot find the shares feature, you may need to install the File Server role to enable the functionality.

![File Server Role](/media/gso_demo_sharesrole.png)

#### Create a Service Principal Name

Another configuration needed for our practice is to set up the stage for a *kerberoasting* attack by creating a *[Service Principal Name (SPN)](https://learn.microsoft.com/en-us/sql/database-engine/configure-windows/register-a-service-principal-name-for-kerberos-connections?view=sql-server-ver17)* tied to the service account we created earlier. The command below is used to create the SPN.

```
setspn -s MSSQLSvc/AJRC-DC.ajrc.local:1433 ajrc\sql.srv
```

You can read more about the `setspn` command [here](https://learn.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2012-R2-and-2012/cc731241(v=ws.11)#viewing-spns).

```
> hostname
AJRC-DC

> net user
User accounts for \\AJRC-DC

-------------------------------------------------
Administrator  david.cahun  Guest
krbtgt         sebastian.gomez  sql.srv
The command completed successfully.

> setspn -s MSSQLSvc/AJRC-DC.ajrc.local:1433 ajrc\sql.srv
Checking domain DC=ajrc,DC=local

Registering ServicePrincipalNames for CN=SQL Service,CN=Users,DC=ajrc,DC=local
    MSSQLSvc/AJRC-DC.ajrc.local:1433
Updated object

> setspn -T ajrc.local -Q */*
Checking domain DC=ajrc,DC=local

CN=AJRC-DC,OU=Domain Controllers,DC=ajrc,DC=local
    Dfsr-12F29C2E-B797-4787-9364-D31B6C55EB04/AJRC-DC.ajrc.local
    ldap/AJRC-DC.ajrc.local/ForestDnsZones.ajrc.local
    ldap/AJRC-DC.ajrc.local/DomainDnsZones.ajrc.local
    ldap/AJRC-DC.ajrc.local
    
    ...

    ldap/AJRC-DC.ajrc.local/AJRC

CN=krbtgt,CN=Users,DC=ajrc,DC=local
    kadmin/changepw

CN=SQL Service,CN=Users,DC=ajrc,DC=local
    MSSQLSvc/AJRC-DC.ajrc.local:1433

Existing SPN found!
```

#### Disable Windows Defender

Following the same argument of *The Cyber Mentor*'s YT video, create a GPO to disable Windows Defender.

The goal of this demo is to demonstrate how real red team attacks can be detected with Google SecOps. If Windows Defender is in the way, it will be more difficult to make that demonstration.

Of course, in a real environment we want Windows Defender enabled as another layer of defense. The detection mechanisms that we will implement will only miss the AV Evasion techniques and subtechniques.

Create the GPO `Disable Windows Defender` at the domain level. Right-click to the new GPO and make sure that the `Enforced` option is selected.

Then, in the GPO, enable the policy `Turn off Microsoft Defender Antivirus` under `Computer Configuration > Policies > Administrative Templates > Microsoft Defender Antivirus`.

![Turn Off Microsoft Defender Antivirus Policy](/media/gso_demo_turnoffdefender.png)

#### Enable Windows Remote Desktop (Optional)

You can also enable Windows RDP for all clients, which will be helpful if you are using Proxmox as your virtualization engine.

In the path:

```
Computer Configuration -> Policies -> Administrative Templates -> Windows Components -> Remote Desktop Services -> Remote Desktop Session Host -> Connections
```

Enable the policy `Allow users to connect remotely using Remote Desktop Services`.

### Windows 10 Pro - Workstation

1. In the network adapters, **configure the domain server address with the DC's address**. Failing in setting up this correctly will unable you to join the domain.
2. **Configure the appropiate timezone**.
3. In the windows search explorer, type *About your PC* and click on *Rename this PC (Advanced)*. In the *System Properties* window, **join to the windows domain** (and change your hostname if you have not do it yet).

![Join a Windows Domain](/media/gso_demo_joindomain.png)

Restart the computer and then login with the domain administrator account `[DomainName]\Administrator`. Open *Computer Management*, and in `Local Users and Groups > Groups`, add one of the previously created users as (local) administrator.

![Add user as local administrator](/media/gso_demo_addlocaladmin.png)

### Windows 10 Pro - WEC

Repeat the same steps listed in the section [Windows 10 Pro - Workstation](#windows-10-pro---workstation). Just make sure that in this computer you add two different local administrators.

### Set-up Blue Team Side Visibility settings

Now that the environment context is up and running, let's enable the observability mechanisms that will help us detect suspicious and malicious incidents.

#### Deploy Windows Sysmon

To deploy Windows Sysmon in a Windows domain effectively, read this [file](/sysmon/README.md) and the [Documentation on Windows Sysmon Deployment](/sysmon/docs/WINDOWS_SYSMON_DEPLOYMENT.md) (You can deliberately use the vulnerable shared folder we created earlier to install Sysmon).


#### Enable Detailed Windows logging

Windows by default is very quiet. You need to enable more granular audit policies.

Either on target machine or via GPO, run the following command to enable all logging mechanisms:

```
AuditPol /set /category:* /success:enable /failure:enable
```

```diff
- Warning: Enabling all logging mechanisms may affect the performance of the machine or fill the disk space
```

Or if you think you know which audit categories are relevant for each tactic and technique, you can also specify by category:

```
AuditPol /get /category:*
[Output all categories]

AuditPol /set /subcategory:"Logon" /success:enable /failure:enable
AuditPol /set /subcategory:"Process Creation" /success:enable
```

Moreover, sometimes we want to monitor commands. Event [4688](https://learn.microsoft.com/en-us/previous-versions/windows/it-pro/windows-10/security/threat-protection/auditing/event-4688) can be extended by running the following command:

```
reg add "HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System\Audit" /v ProcessCreationIncludeCmdLine_Enabled /t REG_DWORD /d 1 /f
```

This will make the event *4688* populate the *command line* field.

For more granular inspection of scripting activities, you can monitor any executed PowerShell command by enabling *Script Block Logging* and/or *Module Logging*:

```
Set-ItemProperty -Path "HKLM:\SOFTWARE\Policies\Microsoft\Windows\PowerShell\ScriptBlockLogging" -Name "EnableScriptBlockLogging" -Value 1
Set-ItemProperty -Path "HKLM:\SOFTWARE\Policies\Microsoft\Windows\PowerShell\ModuleLogging" -Name "EnableModuleLogging" -Value 1
```

Finally, keep in mind that with Sysmon, some of these events are better covered. For example, process creation with Sysmon is far more detailed that event *4688* even with the command line field populated, and the structure of the query is easier to query, read, and parse.

#### Collect the Logs in the WEC

To set up the WEC, read this [file](/wef/README.md). You could find the **Wef Managment Tool** very useful for this task.

## Performing the Attacks and Identifying the Relevant Events

