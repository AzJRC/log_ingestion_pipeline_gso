# On the Fly Note-Taking: Google SecOps Demo - Log Ingestion, Threat detection, Incident Response, and Investigation

This file documents the process I followed on the fly; i.e., at the same time of writing this file, to set up a demonstration of Google Security Operations to ingest events, detect and incident, respond to an incident, and investigate the incident.

1. **Log Ingestion**: Is the process of setting up the telemetry pipeline that is received by the security solution, in this case GSO. The ingestion phase will cover the deployment of a log ingestion pipeline and the deliberated generation of suspicious and malicious events.

2. **Threat Detection**: The process of generating alerts in the security solution. For Google SecOps, this corresponds to enabling Mandiant curated detection, developing custom detection rules.

3. **Incident Response**: The process of inspecting the alerts generated by the security solution, assign responsibles, and perform triaging operations. If applicable, leverage SOAR workflows to automate actions.

4. **Investigation**: The process of analyzing the data and information from the incident. Afterwards, forensic operations can be pursued in the affected hosts to determine the root causes of the incident.

Moreover, there are other features of Google SecOps that we will cover, like the Looker Dashboards, useful for analytics in every phase of security operations. Other advanced features like Google Threat Intelligence and Google SecOps SOAR connectors (alerts) are out-of-scope of this demo.

## Environment Prerequisites

For this demo I will be using Proxmox VE 8.3.3 to run some virtual machines:

- Windows Server 2019 (Domain Controller, DC)
- Windows 10 Pro (Workstation, WS)
- Windows 10 Pro (Optional Windows Event Collector, WEC; WS otherwise)
- Optionally, an OPNSense Firewall (Optional Gateway, GW)

Additionally, you can create another VM for Kali Linux or just use your host/physical computer for that matter.

There is no reason to use Proxmox VE (VirualBox or VMWare would also do the trick) or to virtualize the environment, as long as you have the equipment though.

Most of the setup for this environment was taken from The Cyber Mentor's YouTube video [Hacking Active Directory for Beginners](https://www.youtube.com/watch?v=VXxH4n684HE&t=1304s&ab_channel=TheCyberMentor)
, with a few additions. You can follow along that video while considering the extra configuration steps listed in this file.

![Topology](/media/gso_demo_topology.jpg)

### Proxmox Configuration

Configure [NTP servers](https://developers.google.com/time/guides#linux) in Proxmox host to ensure that the virtual machines have a proper time when initialized.

Create the virtual machines with [Windows Server 2019](https://pve.proxmox.com/wiki/Windows_2019_guest_best_practices) and two with [Windows 10](https://pve.proxmox.com/wiki/Windows_10_guest_best_practices). Finally, create a last VM for the [OPNSense Firewall](https://www.zenarmor.com/docs/network-security-tutorials/opnsense-installation).

![Pene](/media/gso_demo_ntpconfig.png)

### OPNSense Firewall

Deploy the firewall as the gateway between your physical network and your virtual network. No special configuration is implemented here.

### Windows Server 2019 - Domain Controller

#### Essential settings

1. **Change the computer hostname**. For Example: `DC01` or `LAB-DC`.
2. **Configure static IPv4 addressing**. 
    - If you decided to include the OPNsense Firewall as separator between the physical network and the virtual environment, use the internal network address. For example, I used the network `172.16.0.0/24` and I assigned the IP address `172.16.0.100` to my DC.
    - If you didn't add the OPNsense Firewall, still assign a static free address from your local network.
3. **Configure the timezone**.
4. **Run Windows Update**.
5. Make sure you **enable Windows Remote Desktop**.
    - In my lab, one of my WS will have two NICs, one facing the physical network and another facing to the virtual network. This is to avoid having to set up port forwarding or VPNs.
    - Having a direct connection to that WS, and it having access to the virtual network, I can use Windows RDP to access any computer in the laboratory.

Once you have your DC with the most essential configurations ready, move to *AD Users and Computers* to create some user accounts and give your environment a little bit more of context and live.

#### Create users

1. **Create a normal user account** with a weak password (E.g. 'Password1').
2. **Create an administrator user account** with a barely secure password by right-clicking the Administrator user and selecting the *copy* option (E.g. 'P4ssw0rd.').
3. **Create a service account** (E.g. 'SQL Service') with a somewhat secure password that is  included in the user's description in plaintext (E.g. 'MyS3cur3P4ssw0rd!').

#### Create a network share

Create a basic network share. Go to *File and Storage Services > Shares* and create a new *Quick SMB Share*. Name the share as you which; you can leave all settings in their default values. As an example, I created the network share `C:\Shares\Developers`.

If you cannot find the shares feature, you may need to install the File Server role to enable the functionality.

![File Server Role](/media/gso_demo_sharesrole.png)

#### Create a Service Principal Name

Another configuration needed for our practice is to set up the stage for a *kerberoasting* attack by creating a *[Service Principal Name (SPN)](https://learn.microsoft.com/en-us/sql/database-engine/configure-windows/register-a-service-principal-name-for-kerberos-connections?view=sql-server-ver17)* tied to the service account we created earlier. The command below is used to create the SPN.

```
setspn -s MSSQLSvc/AJRC-DC.ajrc.local:1433 ajrc\sql.srv
```

You can read more about the `setspn` command [here](https://learn.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2012-R2-and-2012/cc731241(v=ws.11)#viewing-spns).

```
> hostname
AJRC-DC

> net user
User accounts for \\AJRC-DC

-------------------------------------------------
Administrator  david.cahun  Guest
krbtgt         sebastian.gomez  sql.srv
The command completed successfully.

> setspn -s MSSQLSvc/AJRC-DC.ajrc.local:1433 ajrc\sql.srv
Checking domain DC=ajrc,DC=local

Registering ServicePrincipalNames for CN=SQL Service,CN=Users,DC=ajrc,DC=local
    MSSQLSvc/AJRC-DC.ajrc.local:1433
Updated object

> setspn -T ajrc.local -Q */*
Checking domain DC=ajrc,DC=local

CN=AJRC-DC,OU=Domain Controllers,DC=ajrc,DC=local
    Dfsr-12F29C2E-B797-4787-9364-D31B6C55EB04/AJRC-DC.ajrc.local
    ldap/AJRC-DC.ajrc.local/ForestDnsZones.ajrc.local
    ldap/AJRC-DC.ajrc.local/DomainDnsZones.ajrc.local
    ldap/AJRC-DC.ajrc.local
    
    ...

    ldap/AJRC-DC.ajrc.local/AJRC

CN=krbtgt,CN=Users,DC=ajrc,DC=local
    kadmin/changepw

CN=SQL Service,CN=Users,DC=ajrc,DC=local
    MSSQLSvc/AJRC-DC.ajrc.local:1433

Existing SPN found!
```

#### Disable Windows Defender

Following the same argument of *The Cyber Mentor*'s YT video, create a GPO to disable Windows Defender.

The goal of this demo is to demonstrate how real red team attacks can be detected with Google SecOps. If Windows Defender is in the way, it will be more difficult to make that demonstration.

Of course, in a real environment we want Windows Defender enabled as another layer of defense. The detection mechanisms that we will implement will only miss the AV Evasion techniques and subtechniques.

Create the GPO `Disable Windows Defender` at the domain level. Right-click to the new GPO and make sure that the `Enforced` option is selected.

Then, in the GPO, enable the policy `Turn off Microsoft Defender Antivirus` under `Computer Configuration > Policies > Administrative Templates > Microsoft Defender Antivirus`.

![Turn Off Microsoft Defender Antivirus Policy](/media/gso_demo_turnoffdefender.png)

#### Enable Windows Remote Desktop (Optional)

You can also enable Windows RDP for all clients, which will be helpful if you are using Proxmox as your virtualization engine.

In the path:

```
Computer Configuration -> Policies -> Administrative Templates -> Windows Components -> Remote Desktop Services -> Remote Desktop Session Host -> Connections
```

Enable the policy `Allow users to connect remotely using Remote Desktop Services`.

### Windows 10 Pro - Workstation

1. In the network adapters, **configure the domain server address with the DC's address**. Failing in setting up this correctly will unable you to join the domain.
2. **Configure the appropiate timezone**.
3. **Turn on network discovery and file sharing**.
4. In the windows search explorer, type *About your PC* and click on *Rename this PC (Advanced)*. In the *System Properties* window, **join to the windows domain** (and change your hostname if you have not do it yet).

![Join a Windows Domain](/media/gso_demo_joindomain.png)

Restart the computer and then login with the domain administrator account `[DomainName]\Administrator`. Open *Computer Management*, and in `Local Users and Groups > Groups`, add one of the previously created users as (local) administrator.

![Add user as local administrator](/media/gso_demo_addlocaladmin.png)

### Windows 10 Pro - WEC

Repeat the same steps listed in the section [Windows 10 Pro - Workstation](#windows-10-pro---workstation). Just make sure that in this computer you add two different local administrators.

If you decide to set up this machine as a WEC, follow the instructions of the section [Collect the Logs in the WEC (Optional)](#collect-the-logs-in-the-wec-optional)

## Ingestion Pipeline and Blue Team Side Visibility Settings

Now that the environment context is up and running, let's enable the observability mechanisms that will help us detect suspicious and malicious incidents.

### Install BindPlane Agents

To forward the collected events to Google SecOps, you will need an agent. Google recommends using the partner solution BindPlane, but if you do not have access to this solution, you can always use another alternative:

1. Winlogbeat (Elastic)
2. NXLog
3. Rsyslog for Windows

The benefit of using BindPlane solution, besides being optimized for Google SecOps, is that you can make the ingestion pipeline point-to-point. With the other alternatives, you'll need to use the proxy solution [Google SecOps Forwarder](#) 

```
[TODO] Dev Note: Add documentation of Google SecOps Forwarder.
```

This demo asumes that we are going to use the [Cloud BindPlane Agent](https://bindplane.com/).

#### Access the web portal

1. Go to `https://bindplane.com/` and sign in with your account.
2. Add a source configuration that consumes standard windows event logs.
3. Add a destination configuration that sends logs to Google SecOps.
    - Use `gRPC` protocol
    - Use `JSON` authentication method and paste the content of the `auth.json` file provided by Google SecOps.
    - Optionally, add your domain in the namespace value.
    - Optionally, add the label `env` with value `test`.
4. In the agents tab, click on `Install agents`
5. Copy the installation script in a privileged terminal for each computer you want to install BindPlane.
    - If using WECs, you will only install BindPlane in these computers.
    - In such case, you'll need to tweek the source configuration of your agents to read the custom event logs.
6. Make sure the computers' hostname appears in the web UI.

![](/media/gso_demo_installbindplaneagent.png)
![](/media/gso_demo_bindplaneagentsadded.png)

You can read more about BindPlane agent [here](#TODO )

```
[TODO] Dev Note: Add documentation of BindPlane.
```

### Deploy Windows Sysmon

To deploy Windows Sysmon in a Windows domain effectively, read this [file](/sysmon/README.md) and the [Documentation on Windows Sysmon Deployment](/sysmon/docs/WINDOWS_SYSMON_DEPLOYMENT.md) (You can deliberately use the vulnerable shared folder we created earlier to install Sysmon).

### Enable Detailed Windows logging

Windows by default is very quiet. You need to enable more granular audit policies.

Either on target machine or via GPO, run the following command to enable all logging mechanisms:

```
AuditPol /set /category:* /success:enable /failure:enable
```

```diff
- Warning: Enabling all logging mechanisms may affect the performance of the machine or fill the disk space
```

Or if you think you know which audit categories are relevant for each tactic and technique, you can also specify by category:

```
AuditPol /get /category:*
[Output all categories]

AuditPol /set /subcategory:"Logon" /success:enable /failure:enable
AuditPol /set /subcategory:"Process Creation" /success:enable
```

Moreover, sometimes we want to monitor commands. Event [4688](https://learn.microsoft.com/en-us/previous-versions/windows/it-pro/windows-10/security/threat-protection/auditing/event-4688) can be extended by running the following command:

```
reg add "HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System\Audit" /v ProcessCreationIncludeCmdLine_Enabled /t REG_DWORD /d 1 /f
```

This will make the event *4688* populate the *command line* field.

For more granular inspection of scripting activities, you can monitor any executed PowerShell command by enabling *Script Block Logging* and/or *Module Logging*:

```
Set-ItemProperty -Path "HKLM:\SOFTWARE\Policies\Microsoft\Windows\PowerShell\ScriptBlockLogging" -Name "EnableScriptBlockLogging" -Value 1
Set-ItemProperty -Path "HKLM:\SOFTWARE\Policies\Microsoft\Windows\PowerShell\ModuleLogging" -Name "EnableModuleLogging" -Value 1
```

Finally, keep in mind that with Sysmon, some of these events are better covered. For example, process creation with Sysmon is far more detailed that event *4688* even with the command line field populated, and the structure of the query is easier to query, read, and parse.

```diff
+ Important: You do not need to enable all logging at once. In the following sections, I'll give you the details of which event logs are important to monitor for each adversary technique, and which advanced logging features should be enabled in such case.
```

### Collect the Logs in the WEC (Optional)

To set up the WEC, read this [file](/wef/README.md). You could find the **Wef Managment Tool** very useful for this task.

## Performing the Attacks and Identifying the Relevant Events

All the attacks outlined in this section are taken from The Cyber Mentor's YouTube video [Hacking Active Directory for Beginners](https://youtu.be/VXxH4n684HE?si=gjWkzIV0L4qcJqys)

### LLMNR Poisoning

LLMNR (Link Local Multicast Name Resolution) is a Windows feature that allows computers to resolve names of other computers in a network, as a fallback when DNS services fail or are not enabled.

Note: Keep in mind that this document is mostly about detection techniques rather than mitigation techniques. You won't find many information about how to mitigate and prevent the adversary techniques described below; however, detection techniques are present.

#### Blue Team: Detect LLMNR Poisoning

For this techniue, this is a network-layer deception attack, so there is little to no direct evidence on the Windows host of the poisoning itself.

Our best bet to detect this kind of malicious activity is to focus on:

1. Network connection logs
    - DNS query (Sysmon 22) to unknown or suspicious DNS queries. Better handled if you have a list of trusted domains or hosts.
2. Windows network firewall logs or external network firewall logs
    - SMB (TCP-445) traffic or LLMNR/NBNS (UDP-5355/UDP-137) communications from unknown or never seen endpoints.

Additionally, you can monitor the following events, which tell the story of the adversary trying to gain initial access to a remote computer.

1. Suspicious authentication events
    - Failed logons (WinEvt 4625) type 3 (Network logon) with unusual or unexpected source IP addresses after suspicious network connections.
    - Successful logons (WinEvt 4624) type 3 (Network logon) with unusual or unexpected source IP address. Especially suspicious after one or many failed logon events or suspicious connections.
    - Logon with explicit credentials (WinEvt 4648) After 4624, from same uncommon src IP addresses. May indicate the use of remote access tools such as xfreerdp or remmina.
    - Network connection (SysmonEvt 3) with unusual or unexpected source IP address.

A event 22 from Sysmon is generated when the victim is lured to search for an unexistent shared resource or mistakenly types a word that is not associated to any network shared resource.

At the time of writing this example, Responder 3.1.6.0 was only able to spoof and poison the LLMNR request only if the client types a trivial word (E.g. "Files") or if the victims types the adversary IP address with path (E.g. "\\192.168.68.123\Files"). In the last case, unfortunately the IP address of the attacker's machine is not included, an instead the QueryName field shows the value wpad (`<Data Name="QueryName">wpad</Data>`). If the victim types a random word (`<Data Name="QueryName">test</Data>`), the field `QueryResults` will include the IP address of any device that answered the query (`<Data Name="QueryResults">fe80::eb26:b9d4:acb3:81b8;::ffff:192.168.68.123;</Data>`) and `msedge.exe` will be executed (generating another event Sysmon 1: Process Creation).

Event examples:
- Profile: Workstation - Victim computer
```XML
<!-- Sysmon 22 - DNS -->

<Event xmlns="http://schemas.microsoft.com/win/2004/08/events/event">
    <System>
        <Provider Name="Microsoft-Windows-Sysmon" Guid="{5770385f-c22a-43e0-bf4c-06f5698ffbd9}" /> 
        <EventID>22</EventID> 
        <Version>5</Version> 
        <Level>4</Level> 
        <Task>22</Task> 
        <Opcode>0</Opcode> 
        <Keywords>0x8000000000000000</Keywords> 
        <TimeCreated SystemTime="2025-07-05T17:31:32.9105570Z" /> 
        <EventRecordID>4801</EventRecordID> 
        <Correlation /> 
        <Execution ProcessID="3068" ThreadID="4100" /> 
        <Channel>Microsoft-Windows-Sysmon/Operational</Channel> 
        <Computer>WS01.ajrc.local</Computer> 
        <Security UserID="S-1-5-18" /> 
    </System>
    <EventData>
        <Data Name="RuleName">-</Data> 
        <Data Name="UtcTime">2025-07-05 17:31:31.516</Data> 
        <Data Name="ProcessGuid">{3b1ba004-6170-6869-f909-000000000700}</Data> 
        <Data Name="ProcessId">10812</Data> 
        <Data Name="QueryName">test</Data> 
        <Data Name="QueryStatus">0</Data> 
        <Data Name="QueryResults">fe80::eb26:b9d4:acb3:81b8;::ffff:192.168.68.123;</Data> 
        <Data Name="Image">C:\Program Files (x86)\Microsoft\Edge\Application\msedge.exe</Data> 
        <Data Name="User">AJRC\sebastian.gomez</Data> 
    </EventData>
</Event>

<!-- 4648 - Login with explicit credentials -->
<Event xmlns="http://schemas.microsoft.com/win/2004/08/events/event">
- <System>
  <Provider Name="Microsoft-Windows-Security-Auditing" Guid="{54849625-5478-4994-a5ba-3e3b0328c30d}" /> 
  <EventID>4648</EventID> 
  <Version>0</Version> 
  <Level>0</Level> 
  <Task>12544</Task> 
  <Opcode>0</Opcode> 
  <Keywords>0x8020000000000000</Keywords> 
  <TimeCreated SystemTime="2025-07-05T18:56:28.6019389Z" /> 
  <EventRecordID>19576</EventRecordID> 
  <Correlation ActivityID="{c41c4182-ec88-0000-8a42-1cc488ecdb01}" /> 
  <Execution ProcessID="664" ThreadID="8748" /> 
  <Channel>Security</Channel> 
  <Computer>WS01.ajrc.local</Computer> 
  <Security /> 
  </System>
- <EventData>
  <Data Name="SubjectUserSid">S-1-5-18</Data> 
  <Data Name="SubjectUserName">WS01$</Data> 
  <Data Name="SubjectDomainName">AJRC</Data> 
  <Data Name="SubjectLogonId">0x3e7</Data> 
  <Data Name="LogonGuid">{00000000-0000-0000-0000-000000000000}</Data> 
  <Data Name="TargetUserName">sebastian.gomez</Data> 
  <Data Name="TargetDomainName">AJRC</Data> 
  <Data Name="TargetLogonGuid">{00000000-0000-0000-0000-000000000000}</Data> 
  <Data Name="TargetServerName">localhost</Data> 
  <Data Name="TargetInfo">localhost</Data> 
  <Data Name="ProcessId">0x504</Data> 
  <Data Name="ProcessName">C:\Windows\System32\svchost.exe</Data> 
  <Data Name="IpAddress">192.168.68.123</Data> 
  <Data Name="IpPort">0</Data> 
  </EventData>
  </Event>

<!-- Sysmon 1 - Process creation -->
<Event xmlns="http://schemas.microsoft.com/win/2004/08/events/event">
    <System>
        <Provider Name="Microsoft-Windows-Sysmon" Guid="{5770385f-c22a-43e0-bf4c-06f5698ffbd9}" /> 
        <EventID>1</EventID> 
        <Version>5</Version> 
        <Level>4</Level> 
        <Task>1</Task> 
        <Opcode>0</Opcode> 
        <Keywords>0x8000000000000000</Keywords> 
        <TimeCreated SystemTime="2025-07-05T17:31:19.8346497Z" /> 
        <EventRecordID>4776</EventRecordID> 
        <Correlation /> 
        <Execution ProcessID="3068" ThreadID="3772" /> 
        <Channel>Microsoft-Windows-Sysmon/Operational</Channel> 
        <Computer>WS01.ajrc.local</Computer> 
        <Security UserID="S-1-5-18" /> 
    </System>
    <EventData>
        <Data Name="RuleName">-</Data> 
        <Data Name="UtcTime">2025-07-05 17:31:19.832</Data> 
        <Data Name="ProcessGuid">{3b1ba004-6167-6869-f209-000000000700}</Data> 
        <Data Name="ProcessId">6260</Data> 
        <Data Name="Image">C:\Program Files (x86)\Microsoft\Edge\Application\msedge.exe</Data> 
        <Data Name="FileVersion">138.0.3351.65</Data> 
        <Data Name="Description">Microsoft Edge</Data> 
        <Data Name="Product">Microsoft Edge</Data> 
        <Data Name="Company">Microsoft Corporation</Data> 
        <Data Name="OriginalFileName">msedge.exe</Data> 
        <Data Name="CommandLine">"C:\Program Files (x86)\Microsoft\Edge\Application\msedge.exe" --single-argument http://192.168.68.123/</Data> 
        <Data Name="CurrentDirectory">C:\Windows\system32\</Data> 
        <Data Name="User">AJRC\sebastian.gomez</Data> 
        <Data Name="LogonGuid">{3b1ba004-5a7b-6869-face-cd0100000000}</Data> 
        <Data Name="LogonId">0x1cdcefa</Data> 
        <Data Name="TerminalSessionId">3</Data> 
        <Data Name="IntegrityLevel">Medium</Data> 
        <Data Name="Hashes">MD5=2994B91BCADC7E826691F765031E17AB,SHA256=DA03BA411259AD83F8313B842ED8F16F7F99CB0CEEE8AF729D9D9FB2E31320F7,IMPHASH=23FF41140CBD1050F401744A4BF949D3</Data> 
        <Data Name="ParentProcessGuid">{3b1ba004-5a7e-6869-8308-000000000700}</Data> 
        <Data Name="ParentProcessId">9844</Data> 
        <Data Name="ParentImage">C:\Windows\explorer.exe</Data> 
        <Data Name="ParentCommandLine">C:\Windows\Explorer.EXE</Data> 
        <Data Name="ParentUser">AJRC\sebastian.gomez</Data> 
    </EventData>
</Event>

<!-- Sysmon 3 - Network Connection -->
<Event xmlns="http://schemas.microsoft.com/win/2004/08/events/event">
 <System>
  <Provider Name="Microsoft-Windows-Sysmon" Guid="{5770385f-c22a-43e0-bf4c-06f5698ffbd9}" /> 
  <EventID>3</EventID> 
  <Version>5</Version> 
  <Level>4</Level> 
  <Task>3</Task> 
  <Opcode>0</Opcode> 
  <Keywords>0x8000000000000000</Keywords> 
  <TimeCreated SystemTime="2025-07-05T18:56:18.1016786Z" /> 
  <EventRecordID>5476</EventRecordID> 
  <Correlation /> 
  <Execution ProcessID="3068" ThreadID="3700" /> 
  <Channel>Microsoft-Windows-Sysmon/Operational</Channel> 
  <Computer>WS01.ajrc.local</Computer> 
  <Security UserID="S-1-5-18" /> 
  </System>
 <EventData>
  <Data Name="RuleName">RDP</Data> 
  <Data Name="UtcTime">2025-07-05 18:56:16.044</Data> 
  <Data Name="ProcessGuid">{3b1ba004-3804-6867-1300-000000000700}</Data> 
  <Data Name="ProcessId">64</Data> 
  <Data Name="Image">C:\Windows\System32\svchost.exe</Data> 
  <Data Name="User">NT AUTHORITY\NETWORK SERVICE</Data> 
  <Data Name="Protocol">tcp</Data> 
  <Data Name="Initiated">false</Data> 
  <Data Name="SourceIsIpv6">false</Data> 
  <Data Name="SourceIp">192.168.68.123</Data> 
  <Data Name="SourceHostname">-</Data> 
  <Data Name="SourcePort">58900</Data> 
  <Data Name="SourcePortName">-</Data> 
  <Data Name="DestinationIsIpv6">false</Data> 
  <Data Name="DestinationIp">192.168.68.21</Data> 
  <Data Name="DestinationHostname">WS01.ajrc.local</Data> 
  <Data Name="DestinationPort">3389</Data> 
  <Data Name="DestinationPortName">ms-wbt-server</Data> 
  </EventData>
  </Event>
```


The following YARA-L rule detects unusual logon attempts (likely course of action) after a theoretical LLMNR Poisoning attack:

```YARA-L
rule ajrc_llmnrPoisoningDetectionImproved {
  meta:
    author = "Alejandro Javier Rodríguez Cantón"
    description = "Detect potential LLMNR poisoning, SMB relay activity by correlating unusual connections with network logons"
    severity = "High"

  events:
    // This rule is namespace/domain/facility specific. Adapt if necesary.
    $e_conn.principal.namespace = "ajrc.local"
    $e_logon.principal.namespace = "ajrc.local"

    // Suspicious connection initiated from outside trusted network
    $e_conn.metadata.event_type = "NETWORK_DNS"
    $e_conn.metadata.vendor_name = "Microsoft"
    $e_conn.principal.user.userid = $user
    $e_conn.principal.asset.hostname = $hostname

    not $user = /system/ nocase                     // Avoid false positives from system DNS queries to 'Untrusted Domains'
    not $e_conn.network.dns.questions.name in regex %AjrcLocal_trustedHostsAndDomains   // Searched suspicious domain/hostname

    // Logon attempt from the same IP after suspicious connection
    $e_logon.metadata.event_type = "USER_LOGIN"
    $e_logon.metadata.vendor_name = "Microsoft"
    $e_logon.target.user.userid = $user             
    $e_logon.target.asset.hostname = $hostname

    // Logon from untrusted network.
    // - Insider attacks won't be detected. You could instead create another regex list
    //   of allowed IP addresses for remote connections.
    not $e_logon.src.ip in cidr %AjrcLocal_trustedNetworks  

    // Sequencing
    $e_conn.metadata.event_timestamp.seconds <= $e_logon.metadata.event_timestamp.seconds

  match:
    $user, $hostname over 15m

  outcome:
    $risk_score = 120

  condition:
    $e_conn and $e_logon
}
```

- The YARA-L rule does not consider Network Firewall logs.
- The YARA-L rule requires a CIDR list `trustedNetworks`.

#### Red Team: Perform LLMNR Poisoning

- Use the attacker rool **Responder** from Impacket's toolkit

Run:

```bash
responder -I {net-if} -wF -v    # Responder 3.1.6.0
```

Then, the victim tries to access a remote resource (E.g. Windows Share), but the reference he use to access it points to the attacker's machine (DNS spoofing + LLMNR Poisoning)

Finally, responder captures the traffic and prints to the console the victim's NTLM Hash, which can be cracked offline.

```bash
hashcat -m 5600 {file-to-crack} {wordlist} -O
```

- The wordlist `rockyou.txt` is under the `/usr/share/wordlist/` directory in Kali Linux by default.
- You can use any other wordlist besides Rockyou. `SecList` GitHub repo contains various useful wordlists.
- `hashcat` won't work in a virtual machine. You need to run it in the physical computer.

### SMB Relay

#### Blue Team: Detect SMB Relay Attack


#### Red Team: Peform SMB Relay Attack

- Disable Responder SMB and HTTP responders in `/usr/share/responder.conf`.
- Run `responder -I {net-if} -rdw -v` to stard Responder.
- Run `ntlmrelayx -tf {target-file} -smb2support`
- Victim tries to access an unexistent resource (or poisoned resource) that points to the attacker's machine.
